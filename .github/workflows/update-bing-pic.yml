name: Update Bing Wallpaper

on:
  schedule:
    # æ¯10åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡æ–°å›¾ç‰‡ (UTCæ—¶é—´)
    - cron: '*/10 * * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update-bing:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PERSONAL_TOKEN || secrets.GITHUB_TOKEN }}

    - name: Setup environment
      run: |
        mkdir -p pic json api/today
        echo "å½“å‰æ—¶é—´: $(date)"
        echo "UTCæ—¶é—´: $(date -u)"

    - name: Get Bing image data
      id: bing-data
      run: |
        # è·å–Bingå›¾ç‰‡æ•°æ®
        echo "æ­£åœ¨è·å–Bingå›¾ç‰‡æ•°æ®..."
        JSON_RESPONSE=$(curl -s "https://www.bing.com/HPImageArchive.aspx?format=js&idx=0&n=1&mkt=en-US")
        echo "Bing APIå“åº”: $JSON_RESPONSE"
        
        # æå–å›¾ç‰‡ä¿¡æ¯
        IMG_URL_SUFFIX=$(echo "$JSON_RESPONSE" | grep -oP '"url":"[^"]*"' | cut -d'"' -f4)
        IMG_DATE=$(echo "$JSON_RESPONSE" | grep -oP '"startdate":"[^"]*"' | cut -d'"' -f4)
        IMG_TITLE=$(echo "$JSON_RESPONSE" | grep -oP '"title":"[^"]*"' | cut -d'"' -f4)
        
        echo "å›¾ç‰‡URLåç¼€: $IMG_URL_SUFFIX"
        echo "å›¾ç‰‡æ—¥æœŸ: $IMG_DATE"
        echo "å›¾ç‰‡æ ‡é¢˜: $IMG_TITLE"
        
        # è®¾ç½®è¾“å‡ºå˜é‡
        echo "img_url_suffix=$IMG_URL_SUFFIX" >> $GITHUB_OUTPUT
        echo "img_date=$IMG_DATE" >> $GITHUB_OUTPUT
        echo "img_title=$IMG_TITLE" >> $GITHUB_OUTPUT
        
        # ä¿å­˜åŸå§‹JSON
        echo "$JSON_RESPONSE" > "json/$IMG_DATE.json"

    - name: Download and process image
      run: |
        IMG_URL_SUFFIX="${{ steps.bing-data.outputs.img_url_suffix }}"
        IMG_DATE="${{ steps.bing-data.outputs.img_date }}"
        
        if [ -z "$IMG_URL_SUFFIX" ]; then
          echo "âŒ æ— æ³•è·å–å›¾ç‰‡URLï¼Œè·³è¿‡ä¸‹è½½"
          exit 0
        fi
        
        echo "æ­£åœ¨ä¸‹è½½å›¾ç‰‡: $IMG_DATE"
        IMG_URL="https://www.bing.com$IMG_URL_SUFFIX"
        
        # ä¸‹è½½å›¾ç‰‡åˆ°picç›®å½•
        if curl -s -L -o "pic/$IMG_DATE.jpg" "$IMG_URL"; then
          echo "âœ… å›¾ç‰‡ä¸‹è½½æˆåŠŸ: pic/$IMG_DATE.jpg"
          ls -la "pic/$IMG_DATE.jpg"
        else
          echo "âŒ å›¾ç‰‡ä¸‹è½½å¤±è´¥"
          exit 1
        fi

    - name: Update today's wallpaper
      run: |
        IMG_DATE="${{ steps.bing-data.outputs.img_date }}"
        TODAY=$(date -u +%Y%m%d)  # ä½¿ç”¨UTCæ—¶é—´
        
        echo "å›¾ç‰‡æ—¥æœŸ: $IMG_DATE"
        echo "ä»Šå¤©æ—¥æœŸ: $TODAY"
        
        # æ£€æŸ¥æ˜¯å¦æ˜¯ä»Šå¤©çš„å›¾ç‰‡
        if [ "$IMG_DATE" = "$TODAY" ]; then
          echo "ğŸ”„ æ›´æ–°ä»Šæ—¥å£çº¸..."
          
          # å¤åˆ¶åˆ°api/todayç›®å½•
          cp "pic/$IMG_DATE.jpg" "api/today/1920x1080.jpg"
          echo "âœ… ä»Šæ—¥å£çº¸å·²æ›´æ–°: api/today/1920x1080.jpg"
          
          # åˆ›å»ºè®¿é—®æ—¥å¿—
          echo "$(date -u): Updated today's wallpaper - $IMG_DATE" >> api/update.log
        else
          echo "ğŸ“… å›¾ç‰‡ä¸æ˜¯ä»Šå¤©çš„ï¼Œè·³è¿‡æ›´æ–°ä»Šæ—¥å£çº¸"
        fi

    - name: Update dates index
      run: |
        IMG_DATE="${{ steps.bing-data.outputs.img_date }}"
        
        if [ -n "$IMG_DATE" ]; then
          # æ›´æ–°æ—¥æœŸç´¢å¼•
          if [ -f dates.txt ]; then
            if ! grep -q "$IMG_DATE" dates.txt; then
              echo "$IMG_DATE" >> dates.txt
              echo "âœ… æ·»åŠ æ–°æ—¥æœŸåˆ°ç´¢å¼•: $IMG_DATE"
            else
              echo "ğŸ“ æ—¥æœŸå·²å­˜åœ¨äºç´¢å¼•: $IMG_DATE"
            fi
          else
            echo "$IMG_DATE" > dates.txt
            echo "âœ… åˆ›å»ºæ—¥æœŸç´¢å¼•: $IMG_DATE"
          fi
          
          # æ˜¾ç¤ºå½“å‰æ‰€æœ‰æ—¥æœŸ
          echo "å½“å‰æ‰€æœ‰æ—¥æœŸ:"
          cat dates.txt || echo "æ— æ—¥æœŸè®°å½•"
        fi

    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        if git diff --quiet && git diff --staged --quiet; then
          echo "ğŸ“ æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤"
        else
          echo "ğŸ”„ æäº¤æ›´æ”¹..."
          git add .
          git commit -m "Auto-update: $(date -u +%Y%m%d-%H%M%S)"
          git push
          echo "âœ… æ›´æ”¹å·²æ¨é€"
        fi
