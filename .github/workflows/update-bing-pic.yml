name: Update Bing Wallpaper

on:
  schedule:
    # 每10分钟检查一次新图片 (UTC时间，注意时区转换)
    - cron: '*/10 * * * *'
    # 每2小时复制一次当天图片为固定名称 (UTC时间)
    - cron: '0 */2 * * *'
  workflow_dispatch: # 允许手动触发

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.PERSONAL_TOKEN }}

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests

    - name: Get Bing Wallpaper
      run: |
        mkdir -p pic json api
        
        # 使用Python脚本获取Bing图片
        cat > bing_wallpaper.py << 'EOF'
        import requests
        import json
        import os
        from datetime import datetime
        
        def get_bing_image():
            # 获取 Bing 图片数据
            url = "https://www.bing.com/HPImageArchive.aspx?format=js&idx=0&n=1&mkt=en-US"
            response = requests.get(url)
            data = response.json()
            
            image_data = data['images'][0]
            img_url_suffix = image_data['url']
            img_date = image_data['startdate']
            full_img_url = f"https://www.bing.com{img_url_suffix}"
            
            print(f"Image URL: {full_img_url}")
            print(f"Image Date: {img_date}")
            
            # 下载图片
            img_response = requests.get(full_img_url)
            pic_filename = f"pic/{img_date}.jpg"
            with open(pic_filename, "wb") as f:
                f.write(img_response.content)
            
            # 保存 JSON 数据
            json_filename = f"json/{img_date}.json"
            with open(json_filename, "w") as f:
                json.dump(image_data, f, indent=2)
            
            return img_date
        
        def copy_todays_wallpaper():
            # 复制当天图片为固定名称
            today = datetime.now().strftime('%Y%m%d')
            source_file = f"pic/{today}.jpg"
            target_file = "api/today/1920x1080.jpg"
            
            if os.path.exists(source_file):
                # 确保目标目录存在
                os.makedirs(os.path.dirname(target_file), exist_ok=True)
                
                # 复制文件
                with open(source_file, 'rb') as src, open(target_file, 'wb') as dst:
                    dst.write(src.read())
                print(f"Copied {source_file} to {target_file}")
                return True
            else:
                print(f"Today's image {source_file} not found yet")
                return False
        
        # 主执行逻辑
        current_date = get_bing_image()
        
        # 只有当当前图片是今天的时候，才复制到api/today目录
        today = datetime.now().strftime('%Y%m%d')
        if current_date == today:
            copy_todays_wallpaper()
        else:
            print(f"Current image date {current_date} is not today {today}, skipping copy")
        
        # 更新日期索引
        dates = set()
        if os.path.exists('dates.txt'):
            with open('dates.txt', 'r') as f:
                dates = set(line.strip() for line in f if line.strip())
        
        dates.add(current_date)
        
        with open('dates.txt', 'w') as f:
            for date in sorted(dates):
                f.write(f"{date}\n")
        
        print(f"Available dates: {len(dates)}")
        EOF
        
        python bing_wallpaper.py

    - name: Commit and Push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        git commit -m "Update Bing wallpaper - $(date +%Y%m%d-%H%M%S)" || echo "No changes to commit"
        git push
