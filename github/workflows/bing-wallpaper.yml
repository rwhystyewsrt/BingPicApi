name: Bing Wallpaper Automation

on:
  schedule:
    # æ¯10åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡æ–°å›¾ç‰‡ (UTCæ—¶é—´)
    - cron: '*/10 * * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  update-wallpaper:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PERSONAL_TOKEN || secrets.GITHUB_TOKEN }}

    - name: Setup directories
      run: |
        mkdir -p pic json api/today
        echo "å·¥ä½œå¼€å§‹æ—¶é—´: $(date -u)"

    - name: Fetch Bing image data
      id: fetch-data
      run: |
        echo "æ­£åœ¨è·å–Bingå›¾ç‰‡æ•°æ®..."
        
        # ä½¿ç”¨æ›´å¯é çš„æ–¹å¼è·å–JSONæ•°æ®
        API_URL="https://www.bing.com/HPImageArchive.aspx?format=js&idx=0&n=1&mkt=en-US"
        JSON_RESPONSE=$(curl -s -f "$API_URL")
        
        if [ $? -ne 0 ]; then
          echo "âŒ æ— æ³•è®¿é—®Bing API"
          exit 1
        fi
        
        echo "Bing APIå“åº”: $JSON_RESPONSE"
        
        # ä½¿ç”¨æ›´å¥å£®çš„æ–¹å¼è§£æJSON
        IMG_URL_SUFFIX=$(echo "$JSON_RESPONSE" | sed -n 's/.*"url":"\([^"]*\)".*/\1/p')
        IMG_DATE=$(echo "$JSON_RESPONSE" | sed -n 's/.*"startdate":"\([^"]*\)".*/\1/p')
        IMG_TITLE=$(echo "$JSON_RESPONSE" | sed -n 's/.*"title":"\([^"]*\)".*/\1/p')
        
        if [ -z "$IMG_URL_SUFFIX" ] || [ -z "$IMG_DATE" ]; then
          echo "âŒ æ— æ³•è§£æBing APIå“åº”"
          echo "URLåç¼€: $IMG_URL_SUFFIX"
          echo "æ—¥æœŸ: $IMG_DATE"
          exit 1
        fi
        
        echo "å›¾ç‰‡URLåç¼€: $IMG_URL_SUFFIX"
        echo "å›¾ç‰‡æ—¥æœŸ: $IMG_DATE"
        echo "å›¾ç‰‡æ ‡é¢˜: $IMG_TITLE"
        
        # ä¿å­˜JSONæ•°æ®
        echo "$JSON_RESPONSE" > "json/$IMG_DATE.json"
        echo "date=$IMG_DATE" >> $GITHUB_OUTPUT

    - name: Download Bing image
      run: |
        IMG_DATE="${{ steps.fetch-data.outputs.date }}"
        echo "æ­£åœ¨ä¸‹è½½å›¾ç‰‡: $IMG_DATE"
        
        # é‡æ–°è·å–URLåç¼€ï¼Œç¡®ä¿æœ€æ–°
        JSON_RESPONSE=$(curl -s "https://www.bing.com/HPImageArchive.aspx?format=js&idx=0&n=1&mkt=en-US")
        IMG_URL_SUFFIX=$(echo "$JSON_RESPONSE" | sed -n 's/.*"url":"\([^"]*\)".*/\1/p')
        
        if [ -z "$IMG_URL_SUFFIX" ]; then
          echo "âŒ æ— æ³•è·å–å›¾ç‰‡URL"
          exit 1
        fi
        
        IMG_URL="https://www.bing.com$IMG_URL_SUFFIX"
        echo "å®Œæ•´å›¾ç‰‡URL: $IMG_URL"
        
        # ä¸‹è½½å›¾ç‰‡
        if curl -s -L -f -o "pic/$IMG_DATE.jpg" "$IMG_URL"; then
          echo "âœ… å›¾ç‰‡ä¸‹è½½æˆåŠŸ"
          ls -la "pic/$IMG_DATE.jpg"
        else
          echo "âŒ å›¾ç‰‡ä¸‹è½½å¤±è´¥"
          exit 1
        fi

    - name: Update today's wallpaper
      run: |
        IMG_DATE="${{ steps.fetch-data.outputs.date }}"
        TODAY=$(date -u +%Y%m%d)
        
        echo "å›¾ç‰‡æ—¥æœŸ: $IMG_DATE"
        echo "ä»Šå¤©æ—¥æœŸ: $TODAY"
        
        # æ£€æŸ¥æ˜¯å¦æ˜¯ä»Šå¤©çš„å›¾ç‰‡
        if [ "$IMG_DATE" = "$TODAY" ]; then
          echo "ğŸ”„ æ›´æ–°ä»Šæ—¥å£çº¸..."
          
          # å¤åˆ¶åˆ°api/todayç›®å½•
          cp "pic/$IMG_DATE.jpg" "api/today/1920x1080.jpg"
          echo "âœ… ä»Šæ—¥å£çº¸å·²æ›´æ–°"
          
          # è®°å½•æ›´æ–°æ—¶é—´
          echo "$(date -u): Updated - $IMG_DATE" > api/update.txt
        else
          echo "ğŸ“… å›¾ç‰‡ä¸æ˜¯ä»Šå¤©çš„ï¼Œè·³è¿‡æ›´æ–°ä»Šæ—¥å£çº¸"
        fi

    - name: Update dates index
      run: |
        IMG_DATE="${{ steps.fetch-data.outputs.date }}"
        
        # æ›´æ–°æ—¥æœŸç´¢å¼•
        if [ -f dates.txt ]; then
          if ! grep -q "^$IMG_DATE$" dates.txt; then
            echo "$IMG_DATE" >> dates.txt
            echo "âœ… æ·»åŠ æ–°æ—¥æœŸ: $IMG_DATE"
          fi
        else
          echo "$IMG_DATE" > dates.txt
          echo "âœ… åˆ›å»ºæ—¥æœŸç´¢å¼•"
        fi
        
        echo "å½“å‰æ‰€æœ‰æ—¥æœŸ:"
        sort dates.txt | uniq | tee dates_sorted.txt
        mv dates_sorted.txt dates.txt

    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ·»åŠ æ‰€æœ‰å¯èƒ½çš„æ–°æ–‡ä»¶
        git add -A
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        if git diff --staged --quiet; then
          echo "ğŸ“ æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤"
        else
          echo "ğŸ”„ æäº¤æ›´æ”¹..."
          git commit -m "Auto-update: $(date -u +%Y%m%d-%H%M%S)"
          git push
          echo "âœ… æ›´æ”¹å·²æ¨é€"
        fi

  deploy-pages:
    needs: update-wallpaper
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Build site structure
      run: |
        # ç¡®ä¿å¿…è¦çš„æ–‡ä»¶å­˜åœ¨
        [ -f CNAME ] || echo "ä½ çš„åŸŸå.com" > CNAME
        touch .nojekyll
        
        # åˆ›å»ºç®€å•çš„ä¸»é¡µ
        cat > index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <title>Bing Wallpaper API</title>
            <meta http-equiv="refresh" content="0; url=/api/today/1920x1080.jpg">
        </head>
        <body>
            <p>Redirecting to today's Bing wallpaper...</p>
            <p>If not redirected, <a href="/api/today/1920x1080.jpg">click here</a>.</p>
        </body>
        </html>
        EOF
        
        # å¦‚æœapi/today/1920x1080.jpgä¸å­˜åœ¨ï¼Œå°è¯•ä»picç›®å½•å¤åˆ¶ä»Šå¤©çš„å›¾ç‰‡
        if [ ! -f "api/today/1920x1080.jpg" ]; then
          TODAY=$(date +%Y%m%d)
          if [ -f "pic/$TODAY.jpg" ]; then
            mkdir -p api/today
            cp "pic/$TODAY.jpg" "api/today/1920x1080.jpg"
            echo "ä½¿ç”¨ä»Šæ—¥å›¾ç‰‡ä½œä¸ºåˆå§‹å£çº¸"
          fi
        fi
        
        echo "æœ€ç»ˆæ–‡ä»¶ç»“æ„:"
        find . -name "*.jpg" | head -10

    - name: Upload to GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: .
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v3
